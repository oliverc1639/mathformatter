<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Integral Calculator</title>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CRTYR8VCRG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-CRTYR8VCRG');
</script>

<!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5494314750287277"
     crossorigin="anonymous"></script>

<!-- Nerdamer (symbolic math) -->
<script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/all.min.js"></script>

<!-- MathQuill (editable math field) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mathquill@0.10.1/build/mathquill.css">
<script src="https://cdn.jsdelivr.net/npm/mathquill@0.10.1/build/mathquill.min.js"></script>

<!-- MathJax (pretty rendering for preview + steps) -->
<script>
  window.MathJax = {
    tex: {inlineMath: [['$', '$'], ['\\(', '\\)']]},
    svg: {fontCache: 'global'}
  };
</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<style>
  :root {
    --bg:#0b0c10; --panel:#12131a; --ink:#e7e9ee;
    --muted:#9aa3b2; --accent:#6ee7ff; --edge:#1c1e29;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  }
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}

  .wrap{max-width:980px;margin:40px auto;padding:0 16px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
  header h1{font-size:22px;margin:0}
  .pill{
    font-size:12px;
    color:var(--panel);
    background:var(--accent);
    padding:2px 8px;
    border-radius:999px
  }
  .muted{color:var(--muted);font-size:13px}

  .card{
    background:var(--panel);
    border-radius:16px;
    padding:14px;
    border:1px solid var(--edge);
    box-shadow:0 1px 0 rgba(255,255,255,.03) inset;
    position:relative;
  }

  /* MathQuill editor styling */
  #mathFieldWrapper{
    background:#0f1017;
    border:1px solid #242635;
    border-radius:12px;
    padding:10px;
    min-height:60px;
    cursor:text;
  }
  #mathFieldWrapper:focus-within{
    border-color:#26c6da;
    box-shadow:0 0 0 1px rgba(38,198,218,0.4);
  }
  #mathField{
    min-height:32px;
  }
  .mq-editable-field{
    color:var(--ink);
    font-size:20px;
  }

  .row{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
    margin-top:10px;
  }
  button{
    appearance:none;
    border:1px solid #2a2d3e;
    background:#161823;
    color:var(--ink);
    padding:8px 12px;
    border-radius:12px;
    cursor:pointer;
    font-size:14px;
  }
  button:hover{border-color:#3a3f58}

  #answerOutput{
    margin-top:8px;
    font-family:ui-monospace,Menlo,Consolas,monospace;
  }

  #previewTitle{
    font-size:12px;
    color:var(--muted);
    margin-top:12px;
    margin-bottom:2px;
  }
  #preview{
    margin-top:0;
    padding:10px;
    border-radius:10px;
    border:1px solid #242635;
    background:#0d1119;
    min-height:40px;
    font-size:15px;
  }

  /* Steps panel (read-only dropdown box) */
  #stepsPanel{
    display:none;
    margin-top:12px;
    border:1px solid #242635;
    border-radius:12px;
    padding:10px;
    background:#0f1017;
  }
  #stepsTitle{
    font-size:13px;
    color:var(--muted);
    margin-bottom:6px;
  }

  /* Bottom row: help + calculator on same Y */
  .bottomRow{
    display:flex;
    gap:16px;
    align-items:flex-start;
    margin-top:14px;
  }
  .help{
    font-size:13px;
    color:var(--muted);
    flex:1;
  }
  .help code{
    background:#0f1017;
    border:1px solid #222434;
    border-radius:4px;
    padding:0 4px;
    font-size:12px;
  }
  .help h3{
    margin:0 0 6px 0;
    font-size:14px;
    color:var(--ink);
  }
  ul{margin-top:4px;margin-bottom:0;padding-left:20px;}

  /* Calculator */
  .calcCard{
    background:#0f1017;
    border:1px solid #242635;
    border-radius:14px;
    padding:10px;
    width:220px;
  }
  .calcTitle{
    font-size:13px;
    color:#9aa3b2;
    margin:0 0 6px 0;
  }
  .calcDisplay{
    width:100%;
    height:36px;
    border:1px solid #242635;
    border-radius:10px;
    background:#0b0c12;
    color:#e7e9ee;
    font:18px/36px ui-monospace,Menlo,Consolas,monospace;
    padding:0 10px;
    text-align:right;
    overflow:hidden;
    white-space:nowrap;
  }
  .calcDisplay:focus{
    outline:2px solid #26c6da;
    outline-offset:2px;
  }
  .calcGrid{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:6px;
    margin-top:6px;
  }
  .key{
    height:32px;
    border:1px solid #2a2d3e;
    background:#161823;
    border-radius:10px;
    color:#e7e9ee;
    font:13px/32px system-ui;
    cursor:pointer;
    text-align:center;
    user-select:none;
  }
  .key.op{background:#1a1d2a}
  .key.eq{background:#1e2a37;border-color:#345}
  .key.wide{grid-column:span 2}
  .key:active{transform:translateY(1px)}
  .calcHelp{
    color:#9aa3b2;
    font-size:11px;
    margin:6px 0 0 0;
    text-align:right;
  }

  /* Report */
  #reportPanel textarea{
    width:100%;
    min-height:90px;
    background:#0f1017;
    color:var(--ink);
    border:1px solid #242635;
    border-radius:10px;
    padding:8px;
    resize:vertical;
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Integral Calculator</h1>
      <span class="pill">Enter = Solve</span>
      <span class="muted">Shift+Enter: newline · <b>int</b> → ∫ · <b>inf</b> → ∞</span>
    </header>

    <section class="card">
      <p class="muted">
        Type an integral and press <b>Enter</b> to solve. Use <b>Shift+Enter</b> for a newline.
        Right after typing <code>int</code>, press <b>↑</b> or <b>↓</b> to create upper / lower bounds on the integral sign.
      </p>

      <!-- MathQuill editor -->
      <div id="mathFieldWrapper">
        <span id="mathField"></span>
      </div>

      <div class="row">
        <button id="clearBtn">Clear</button>
        <button id="copyLastBtn">Copy last answer</button>
        <button id="showStepsBtn">Show steps</button>
        <span id="status" class="muted"></span>
      </div>

      <div id="answerOutput"></div>

      <div id="previewTitle">Live preview (formatted math):</div>
      <div id="preview"></div>

      <!-- Read-only steps dropdown -->
      <div id="stepsPanel" aria-live="polite">
        <div id="stepsTitle">Steps for last integral</div>
        <div id="stepsContent"></div>
      </div>

      <div class="bottomRow">
        <!-- Left: help -->
        <div class="help">
          <h3>How to write integrals:</h3>
          <ul>
            <li><code>int x^2 dx</code> → <code>∫ x^2 dx</code> (single integral)</li>
            <li><code>int int x*y dx dy</code> → <code>∫ ∫ x*y dx dy</code> (double integral)</li>
            <li><code>int int int z dx dy dz</code> → triple integral</li>
            <li>Right after <code>int</code>, press <b>↑</b> or <b>↓</b> to create bounds: <code>∫<sub>bottom</sub><sup>top</sup></code></li>
            <li>Type <code>inf</code> to get <code>∞</code> (works in bounds).</li>
            <li>Definite / improper integrals:
              <ul>
                <li><code>∫<sub>0</sub><sup>1</sup> x^2 dx</code></li>
                <li><code>∫<sub>0</sub><sup>∞</sup> e^(-x) dx</code></li>
                <li>or bracket form: <code>∫[0,∞] e^(-x) dx</code></li>
              </ul>
            </li>
            <li>Superscripts & subscripts: use <code>^</code> and <code>_</code> (e.g. <code>x^2</code>, <code>a_1</code>); they render properly.</li>
          </ul>
        </div>

        <!-- Right: calculator, aligned with heading -->
        <div class="calcCard">
          <p class="calcTitle">Calculator</p>
          <div id="calcDisplay" class="calcDisplay" tabindex="0"
               aria-label="Calculator display" title="Click to type with keyboard">0</div>
          <div class="calcGrid">
            <div class="key op" data-key="C">C</div>
            <div class="key op" data-key="Backspace">⌫</div>
            <div class="key op" data-key="/">÷</div>
            <div class="key op" data-key="*">×</div>

            <div class="key" data-key="7">7</div>
            <div class="key" data-key="8">8</div>
            <div class="key" data-key="9">9</div>
            <div class="key op" data-key="-">−</div>

            <div class="key" data-key="4">4</div>
            <div class="key" data-key="5">5</div>
            <div class="key" data-key="6">6</div>
            <div class="key op" data-key="+">+</div>

            <div class="key" data-key="1">1</div>
            <div class="key" data-key="2">2</div>
            <div class="key" data-key="3">3</div>
            <div class="key eq" data-key="=">=</div>

            <div class="key wide" data-key="0">0</div>
            <div class="key" data-key=".">.</div>
            <div class="key eq" data-key="Enter">=</div>
          </div>
          <div class="calcHelp">Keyboard: 0–9 . + − * / Enter, C, ⌫</div>
        </div>
      </div>

      <!-- Report Problem / Contact -->
      <div style="margin-top:14px;border-top:1px solid #242635;padding-top:10px;">
        <button id="reportBtn">Report a Problem / Contact Us</button>
        <div id="reportPanel" style="display:none;margin-top:6px;">
          <textarea id="reportMsg"
            placeholder="What did you type? What happened? What did you expect?"></textarea>
          <div class="row" style="margin-top:6px">
            <button id="reportSubmit">Submit</button>
            <button id="reportCancel">Cancel</button>
          </div>
          <div id="reportStatus" class="muted"></div>
        </div>
      </div>
    </section>

    <p style="text-align:center; margin:16px 0 32px;">
      <a href="privacy.html">Privacy Policy</a> |
      <a href="terms.html">Terms &amp; Conditions</a>
    </p>
  </div>

<script>
/* ===== MathQuill setup ===== */
const MQ = MathQuill.getInterface(2);
const mathFieldSpan = document.getElementById('mathField');
const mathField = MQ.MathField(mathFieldSpan, {
  spaceBehavesLikeTab: true,
  autoOperatorNames: 'sin cos tan log ln',
  handlers: {
    edit: () => updatePreview()
  }
});

const statusEl     = document.getElementById('status');
const previewEl    = document.getElementById('preview');
const stepsPanel   = document.getElementById('stepsPanel');
const stepsContent = document.getElementById('stepsContent');
const answerOutput = document.getElementById('answerOutput');

let lastAnswer    = '';
let lastStepsHTML = '';
let typedWord     = '';
let integralFresh = false; // true right after converting 'int' → ∫

function flashStatus(msg){
  statusEl.textContent = msg;
  if (!msg) return;
  setTimeout(()=>{ statusEl.textContent=''; }, 2000);
}

function escHtml(s){
  return String(s).replace(/[&<>]/g, ch => (
    ch === '&' ? '&amp;' :
    ch === '<' ? '&lt;'  :
    '&gt;'
  ));
}

/* ASCII-ish → TeX-ish for MathJax (used for steps, not for main MQ latex) */
function exprToTex(s){
  let t = String(s);
  t = t.replace(/\^(\d+)/g, '^{$1}');
  t = t.replace(/_(\d+)/g, '_{$1}');
  t = t.replace(/pi\b/g, '\\pi');
  t = t.replace(/sin\(/g, '\\sin(');
  t = t.replace(/cos\(/g, '\\cos(');
  t = t.replace(/tan\(/g, '\\tan(');
  t = t.replace(/log\(/g, '\\log(');
  t = t.replace(/ln\(/g, '\\ln(');
  return t;
}

function updateSteps(html){
  lastStepsHTML = html || '<p class="muted">No steps available for this input.</p>';
  stepsContent.innerHTML = lastStepsHTML;
  if (stepsPanel.style.display === 'block' && window.MathJax && window.MathJax.typesetPromise) {
    MathJax.typesetPromise([stepsContent]).catch(()=>{});
  }
}

function updatePreview(){
  const latex = mathField.latex();
  if (!latex.trim()){
    previewEl.innerHTML = '<span class="muted">Start typing above to see formatted math here.</span>';
    return;
  }
  const display = '$$' + latex + '$$';
  previewEl.textContent = display;
  if (window.MathJax && window.MathJax.typesetPromise) {
    MathJax.typesetPromise([previewEl]).catch(()=>{});
  }
}

/* ===== Typed word detection for int → ∫ and inf → ∞ ===== */
const editorWrapper = document.getElementById('mathFieldWrapper');

editorWrapper.addEventListener('keydown', (e)=>{
  // letter tracking
  if (e.key.length === 1 && /[a-zA-Z]/.test(e.key)) {
    typedWord += e.key.toLowerCase();
    setTimeout(()=>checkAutoWords(),0);
  } else if (e.key === 'Backspace') {
    typedWord = typedWord.slice(0,-1);
  } else if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
    // handle integral limits immediately
    if (integralFresh) {
      e.preventDefault();
      handleIntegralArrow(e.key);
      return;
    }
    typedWord = '';
  } else if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    solveCurrentExpression();
    typedWord = '';
  } else {
    typedWord = '';
  }
});

function checkAutoWords(){
  // convert 'int' → integral
  if (typedWord.endsWith('int')) {
    for (let i=0;i<3;i++) mathField.keystroke('Backspace');
    mathField.cmd('\\int');
    mathField.write(' ');
    integralFresh = true; // enable arrow-based bounds
    return;
  }
  // convert 'inf' → ∞
  if (typedWord.endsWith('inf')) {
    for (let i=0;i<3;i++) mathField.keystroke('Backspace');
    mathField.cmd('\\infty');
    typedWord = '';
    return;
  }
}

/* ===== Integral bounds behavior right after ∫ ===== */
function handleIntegralArrow(direction){
  // We're sitting just after "∫ " (caret to the right).
  // Move left into the integral symbol, then create both sub and sup
  // and leave caret in top (ArrowUp) or bottom (ArrowDown).

  // move into integral
  mathField.keystroke('Left');

  if (direction === 'ArrowUp') {
    // create lower then upper, end in upper
    mathField.keystroke('_');      // create subscript, caret in it
    mathField.keystroke('Right');  // leave subscript, caret back at integral
    mathField.keystroke('^');      // create superscript, caret in it (top box)
  } else {
    // create upper then lower, end in lower
    mathField.keystroke('^');      // create superscript, caret in it
    mathField.keystroke('Right');  // back to integral
    mathField.keystroke('_');      // create subscript, caret in it (bottom box)
  }

  // after we've created the structure once, don't re-trigger
  integralFresh = false;
}

/* ===== Latex → Nerdamer-friendly text ===== */
function latexToPlain(latex){
  let s = latex;
  // strip spacing and style commands
  s = s.replace(/\\left/g, '');
  s = s.replace(/\\right/g, '');
  s = s.replace(/\\,/g, '');
  s = s.replace(/\\!/g, '');
  s = s.replace(/\\ /g, ' ');
  s = s.replace(/\\cdot/g, '*');
  s = s.replace(/\\times/g, '*');
  s = s.replace(/\\pi/g, 'pi');
  s = s.replace(/\\infty/g, 'Infinity');
  s = s.replace(/\\sin/g, 'sin');
  s = s.replace(/\\cos/g, 'cos');
  s = s.replace(/\\tan/g, 'tan');
  s = s.replace(/\\log/g, 'log');
  s = s.replace(/\\ln/g, 'ln');
  // frac
  s = s.replace(/\\frac{([^}]*)}{([^}]*)}/g, '(($1)/($2))');
  return s;
}

function normalizeBound(v){
  const s = v.trim();
  if (/^(∞|\+?inf|\+?Infinity)$/i.test(s)) return 'Infinity';
  if (/^(-∞|-inf|-Infinity)$/i.test(s))   return '-Infinity';
  return s;
}

/* ===== Solve integral from MathQuill latex ===== */
function solveIntegralFromLatex(latex){
  const plain = latexToPlain(latex);
  const result = { answer:'', stepsHTML:'' };

  const trim = (x)=>x.trim();

  try {
    // 1. Direct nerdamer calls
    if (/integrate\s*\(/.test(plain) || /defint\s*\(/.test(plain)) {
      const res = nerdamer(plain).simplify();
      result.answer = res.toString();
      const texRes = exprToTex(result.answer);
      result.stepsHTML = `
        <p><b>Input:</b></p>
        <p><code>${escHtml(plain)}</code></p>
        <p><b>Result (simplified):</b></p>
        <p>$$${texRes}$$</p>`;
      return result;
    }

    let s = plain.replace(/\s+/g,' ').trim();

    // 2. TeX-style definite (possibly improper): \int_{a}^{b} f(x) dx
    let mTex = s.match(/^\\int\s*_{([^}]*)}\s*\^{([^}]*)}\s*(.+)d([a-zA-Z])\s*$/);
    if (mTex) {
      const aRaw = trim(mTex[1]);
      const bRaw = trim(mTex[2]);
      const expr = trim(mTex[3]);
      const v    = trim(mTex[4]);
      const a = normalizeBound(aRaw);
      const b = normalizeBound(bRaw);

      const F   = nerdamer.integrate(expr, v).simplify();
      const val = nerdamer.defint(expr, v, a, b).simplify();

      const texIntegral = `\\int_{${exprToTex(a)}}^{${exprToTex(b)}} ${exprToTex(expr)}\\, d${v}`;
      const texF   = exprToTex(F.toString());
      const texVal = exprToTex(val.toString());

      result.answer = val.toString();
      result.stepsHTML = `
        <p><b>Given definite integral:</b></p>
        <p>$$${texIntegral}$$</p>
        <p><b>1. Antiderivative:</b></p>
        <p>$$F(${v}) = ${texF}$$</p>
        <p><b>2. Evaluate at bounds:</b></p>
        <p>$$\\int_{${exprToTex(a)}}^{${exprToTex(b)}} ${exprToTex(expr)}\\, d${v}
          = F(${exprToTex(b)}) - F(${exprToTex(a)})$$</p>
        <p><b>3. Final result:</b></p>
        <p>$$${texVal}$$</p>`;
      return result;
    }

    // 3. Bracket-style definite: \int[a,b] f(x) dx  (also possibly improper)
    let mBr = s.match(/^\\int\[\s*([^,]+)\s*,\s*([^\]]+)\]\s*(.+)d([a-zA-Z])\s*$/);
    if (mBr) {
      const aRaw = trim(mBr[1]);
      const bRaw = trim(mBr[2]);
      const expr = trim(mBr[3]);
      const v    = trim(mBr[4]);
      const a = normalizeBound(aRaw);
      const b = normalizeBound(bRaw);

      const F   = nerdamer.integrate(expr, v).simplify();
      const val = nerdamer.defint(expr, v, a, b).simplify();

      const texIntegral = `\\int_{${exprToTex(a)}}^{${exprToTex(b)}} ${exprToTex(expr)}\\, d${v}`;
      const texF   = exprToTex(F.toString());
      const texVal = exprToTex(val.toString());

      result.answer = val.toString();
      result.stepsHTML = `
        <p><b>Given definite integral:</b></p>
        <p>$$${texIntegral}$$</p>
        <p><b>1. Antiderivative:</b></p>
        <p>$$F(${v}) = ${texF}$$</p>
        <p><b>2. Evaluate at bounds:</b></p>
        <p>$$\\int_{${exprToTex(a)}}^{${exprToTex(b)}} ${exprToTex(expr)}\\, d${v}
          = F(${exprToTex(b)}) - F(${exprToTex(a)})$$</p>
        <p><b>3. Final result:</b></p>
        <p>$$${texVal}$$</p>`;
      return result;
    }

    // 4. Count \int occurrences for iterated vs single
    const intMatches = s.match(/\\int/g) || [];
    const intCount   = intMatches.length;

    // 4a. Single indefinite integral: \int f(x) dx
    const mIndef = s.match(/^\\int\s+(.+)\s+d([a-zA-Z])\s*$/);
    if (mIndef && intCount === 1) {
      const expr = trim(mIndef[1]);
      const v    = trim(mIndef[2]);
      const F    = nerdamer.integrate(expr, v).simplify();
      result.answer = F.toString();
      const texInt  = `\\int ${exprToTex(expr)}\\, d${v}`;
      const texF    = exprToTex(result.answer);
      result.stepsHTML = `
        <p><b>Indefinite integral:</b></p>
        <p>$$${texInt}$$</p>
        <p><b>Antiderivative:</b></p>
        <p>$$${texF} + C$$</p>`;
      return result;
    }

    // 4b. Iterated indefinite integrals: \int \int ... dx dy ...
    if (intCount > 1) {
      let rest = s.replace(/^(?:\\int\s*)+/, '');
      let expr = trim(rest);
      const vars = [];

      while (true) {
        const m = expr.match(/^(.*)\bd([a-zA-Z])\s*$/);
        if (!m) break;
        vars.push(trim(m[2]));
        expr = trim(m[1]);
      }

      if (!vars.length) throw new Error('Could not find dx, dy, dz, ... at end.');
      if (vars.length !== intCount) throw new Error(`Found ${intCount} integrals but ${vars.length} variables.`);

      let resExpr = expr;
      const intermediate = [];

      for (let k=vars.length-1;k>=0;k--){
        const v = vars[k];
        resExpr = nerdamer.integrate(resExpr, v).toString();
        intermediate.push({ v, expr: resExpr });
      }

      const finalExpr = nerdamer(resExpr).simplify();
      result.answer = finalExpr.toString();

      const typedOrder = vars.slice().reverse();
      const texOriginal =
        `${'\\int '.repeat(intCount)} ${exprToTex(expr)}\\, ${typedOrder.map(v => 'd'+v).join('\\, ')}`;
      const texSteps = intermediate.map((step, idx) => {
        const v = step.v;
        const texF = exprToTex(step.expr);
        return `<p><b>${idx+1}. Integrate w.r.t. ${v}:</b></p>
                <p>$$${texF}$$</p>`;
      }).join('');
      const texFinal = exprToTex(finalExpr.toString());

      result.stepsHTML = `
        <p><b>Iterated integral:</b></p>
        <p>$$${texOriginal}$$</p>
        ${texSteps}
        <p><b>Final result:</b></p>
        <p>$$${texFinal}$$</p>`;
      return result;
    }

    // 5. Fallback: not recognized
    throw new Error('Expression not recognized as an integral. Use "int" (→ ∫) with dx, dy, etc.');
  } catch (err) {
    const msg = 'Error: ' + (err && err.message ? err.message : String(err));
    result.answer = msg;
    result.stepsHTML = `<p>${escHtml(msg)}</p>`;
    return result;
  }
}

/* ===== Solve current expression (Enter) ===== */
function solveCurrentExpression(){
  const latex = mathField.latex().trim();
  if (!latex) return;
  const {answer, stepsHTML} = solveIntegralFromLatex(latex);
  lastAnswer = answer;
  updateSteps(stepsHTML);

  if (answer && !answer.startsWith('Error:')) {
    answerOutput.textContent = '= ' + answer;
  } else {
    answerOutput.textContent = answer;
  }

  flashStatus('Solved integral.');
}

/* ===== Clear + copy last answer ===== */
document.getElementById('clearBtn').addEventListener('click', ()=>{
  mathField.latex('');
  lastAnswer = '';
  answerOutput.textContent = '';
  updateSteps('');
  updatePreview();
  flashStatus('Cleared.');
  mathField.focus();
});

document.getElementById('copyLastBtn').addEventListener('click', async ()=>{
  if (!lastAnswer) {
    flashStatus('No answer yet to copy.');
    return;
  }
  try {
    await navigator.clipboard.writeText(lastAnswer);
    flashStatus('Last answer copied.');
  } catch {
    flashStatus('Could not copy (clipboard blocked).');
  }
});

/* ===== Show steps dropdown toggle ===== */
document.getElementById('showStepsBtn').addEventListener('click', ()=>{
  if (stepsPanel.style.display === 'block') {
    stepsPanel.style.display = 'none';
  } else {
    stepsPanel.style.display = 'block';
    stepsContent.innerHTML = lastStepsHTML || '<p class="muted">No steps yet. Solve an integral first.</p>';
    if (window.MathJax && window.MathJax.typesetPromise) {
      MathJax.typesetPromise([stepsContent]).catch(()=>{});
    }
  }
});

/* ===== Calculator (same behavior) ===== */
const calcDisplay = document.getElementById('calcDisplay');
let calcBuffer    = '0';
let calcFocused   = false;

function setDisp(s){ calcDisplay.textContent = s; }
function calcAppendKey(k){
  if (k === 'C'){
    calcBuffer = '0'; setDisp(calcBuffer); return;
  }
  if (k === 'Backspace'){
    calcBuffer = calcBuffer.length > 1 ? calcBuffer.slice(0,-1) : '0';
    setDisp(calcBuffer); return;
  }
  if (k === '=' || k === 'Enter'){
    calcTryEval(); return;
  }
  const allowed = /[0-9.+\-*/]/;
  if (!allowed.test(k)) return;
  if (calcBuffer === '0' && /[0-9.]/.test(k)) calcBuffer = '';
  const last = calcBuffer.slice(-1);
  if (/[+\-*/]/.test(last) && /[+\-*/]/.test(k)){
    if (!(k === '-' && (calcBuffer === '' || /[+\-*/(]$/.test(calcBuffer)))) return;
  }
  calcBuffer += k;
  setDisp(calcBuffer);
}
function calcEvalExpr(s){
  if (!/^[0-9.+\-*/\s]+$/.test(s)) return null;
  const tokens = [];
  let i=0;
  while (i<s.length){
    const ch = s[i];
    if (/\s/.test(ch)){ i++; continue; }
    if (/[+\-*/]/.test(ch)){ tokens.push(ch); i++; continue; }
    if (/[0-9.]/.test(ch)){
      let j=i, d=0;
      while (j<s.length && /[0-9.]/.test(s[j])){
        if (s[j]==='.') d++;
        if (d>1) return null;
        j++;
      }
      tokens.push(s.slice(i,j));
      i=j;
      continue;
    }
    return null;
  }
  const out = [];
  for (let k=0;k<tokens.length;k++){
    const t = tokens[k];
    if (t === '-' && (k===0 || /[+\-*/]/.test(tokens[k-1]))){
      const nxt = tokens[k+1];
      if (nxt == null || !/^[0-9.]+$/.test(nxt)) return null;
      out.push(String(-parseFloat(nxt)));
      k++;
    } else out.push(t);
  }
  const prec = {'+':1,'-':1,'*':2,'/':2};
  const ops = [], rpn=[];
  for (const t of out){
    if (/^[0-9.\-]+$/.test(t) && !/^[+\-*/]$/.test(t)) rpn.push(parseFloat(t));
    else if (t in prec){
      while (ops.length && prec[ops[ops.length-1]]>=prec[t]) rpn.push(ops.pop());
      ops.push(t);
    } else return null;
  }
  while (ops.length) rpn.push(ops.pop());
  const st=[];
  for (const t of rpn){
    if (typeof t === 'number') st.push(t);
    else{
      const b = st.pop(), a = st.pop();
      if (a==null || b==null) return null;
      st.push(t==='+'?a+b:t==='-'?a-b:t==='*'?a*b:a/b);
    }
  }
  return st.length===1 ? st[0] : null;
}
function calcTryEval(){
  const expr = calcBuffer;
  const res  = calcEvalExpr(expr);
  if (res==null || !isFinite(res)){
    setDisp('Error');
    calcBuffer='0';
  } else {
    let out = Math.round((res+Number.EPSILON)*1e12)/1e12;
    out = out.toString();
    setDisp(out);
    calcBuffer = out;
  }
}

document.querySelectorAll('.key').forEach(k=>{
  k.addEventListener('click', ()=>calcAppendKey(k.getAttribute('data-key')));
});
calcDisplay.addEventListener('focus', ()=>{ calcFocused = true; });
calcDisplay.addEventListener('blur',  ()=>{ calcFocused = false; });

window.addEventListener('keydown', (e)=>{
  if (!calcFocused) return;
  if (e.metaKey || e.ctrlKey || e.altKey) return;
  const k = e.key;
  if ((/^[0-9]$/.test(k)) || k==='.' || k==='+' || k==='-' ||
      k==='*' || k==='/' || k==='Enter' || k==='=' || k==='Backspace' ||
      k==='c' || k==='C'){
    e.preventDefault();
    calcAppendKey(k === 'c' ? 'C' : k);
  }
});

/* ===== Report Problem (mailto) ===== */
const reportBtn     = document.getElementById('reportBtn');
const reportPanel   = document.getElementById('reportPanel');
const reportMsg     = document.getElementById('reportMsg');
const reportSubmit  = document.getElementById('reportSubmit');
const reportCancel  = document.getElementById('reportCancel');
const reportStatus  = document.getElementById('reportStatus');

reportBtn.addEventListener('click', ()=>{
  const show = reportPanel.style.display !== 'block';
  reportPanel.style.display = show ? 'block' : 'none';
  if (show) reportMsg.focus();
});

reportCancel.addEventListener('click', ()=>{
  reportPanel.style.display='none';
  reportStatus.textContent='';
});

reportSubmit.addEventListener('click', ()=>{
  const msg = (reportMsg.value || '').trim();
  if (!msg){
    reportStatus.textContent='Please write a short description.';
    return;
  }
  const subject = encodeURIComponent('Integral Calculator — Problem Report');
  const context = '\n\n---\nCurrent math (LaTeX):\n' +
                  (mathField.latex() || '').slice(0, 4000);
  const body    = encodeURIComponent(msg + context);
  const mailto  = `mailto:oliver.c1639@gmail.com?subject=${subject}&body=${body}`;

  reportPanel.style.display = 'none';
  reportStatus.textContent  = 'Thanks! Your mail app should open — just hit send.';
  window.location.href = mailto;
});

/* Initial preview */
updatePreview();
</script>
</body>
</html>
