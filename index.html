<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Integral Calculator</title>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CRTYR8VCRG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-CRTYR8VCRG');
</script>

<!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5494314750287277"
     crossorigin="anonymous"></script>

<!-- Nerdamer (symbolic math, integrals) -->
<script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/all.min.js"></script>

<!-- MathJax for pretty superscripts/subscripts in steps -->
<script>
  window.MathJax = {
    tex: {inlineMath: [['$', '$'], ['\\(', '\\)']]},
    svg: {fontCache: 'global'}
  };
</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<style>
  :root {
    --bg:#0b0c10; --panel:#12131a; --ink:#e7e9ee;
    --muted:#9aa3b2; --accent:#6ee7ff; --edge:#1c1e29;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  }
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}

  .wrap{max-width:980px;margin:40px auto;padding:0 16px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  header h1{font-size:20px;margin:0}
  .pill{
    font-size:12px;
    color:var(--panel);
    background:var(--accent);
    padding:2px 8px;
    border-radius:999px
  }
  .muted{color:var(--muted);font-size:13px}

  .card{
    background:var(--panel);
    border-radius:16px;
    padding:14px;
    border:1px solid var(--edge);
    box-shadow:0 1px 0 rgba(255,255,255,.03) inset;
  }

  #editor{
    width:100%;
    min-height:260px;
    background:#0f1017;
    border:1px solid #242635;
    border-radius:12px;
    padding:12px;
    outline:none;
    color:var(--ink);
    font:15px/1.4 ui-monospace,Menlo,Consolas,monospace;
    resize:vertical;
    white-space:pre-wrap;
  }

  .row{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
    margin-top:10px;
  }
  button{
    appearance:none;
    border:1px solid #2a2d3e;
    background:#161823;
    color:var(--ink);
    padding:8px 12px;
    border-radius:12px;
    cursor:pointer;
    font-size:14px;
  }
  button:hover{border-color:#3a3f58}

  .help{
    margin-top:12px;
    font-size:13px;
    color:var(--muted);
  }
  .help code{
    background:#0f1017;
    border:1px solid #222434;
    border-radius:4px;
    padding:0 4px;
    font-size:12px;
  }

  ul{margin-top:6px;margin-bottom:0;padding-left:20px;}

  /* Steps panel (read-only dropdown box) */
  #stepsPanel{
    display:none;
    margin-top:12px;
    border:1px solid #242635;
    border-radius:12px;
    padding:10px;
    background:#0f1017;
  }
  #stepsTitle{
    font-size:13px;
    color:var(--muted);
    margin-bottom:6px;
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Integral Calculator</h1>
      <span class="pill">Enter = Solve</span>
      <span class="muted">Shift+Enter for newline · <b>int␣</b> → ∫</span>
    </header>

    <section class="card">
      <p class="muted">
        Type an integral on its own line and press <b>Enter</b>.
        The answer will appear <b>two lines below</b> that line.
        Use <b>Shift+Enter</b> to insert a normal newline without solving.
      </p>

      <textarea id="editor" spellcheck="false"
        aria-label="Integral input area"
        placeholder="Examples:
int x^2 dx
int int x*y dx dy
int int int z dx dy dz
int[0,1] x^2 dx
integrate(sin(x)^2, x)
defint(exp(x), x, 0, 1)"></textarea>

      <div class="row">
        <button id="clearBtn">Clear</button>
        <button id="copyLastBtn">Copy last answer</button>
        <button id="showStepsBtn">Show steps</button>
        <span id="status" class="muted"></span>
      </div>

      <!-- Read-only steps dropdown -->
      <div id="stepsPanel" aria-live="polite">
        <div id="stepsTitle">Steps for last integral</div>
        <div id="stepsContent"></div>
      </div>

      <div class="help">
        <b>How to write integrals:</b>
        <ul>
          <li><code>int x^2 dx</code> → auto becomes <code>∫ x^2 dx</code> (single integral)</li>
          <li><code>int int x*y dx dy</code> → <code>∫ ∫ x*y dx dy</code> (double integral)</li>
          <li><code>int int int z dx dy dz</code> → triple integral</li>
          <li><code>int[0,1] x^2 dx</code> → <code>∫[0,1] x^2 dx</code> (definite integral)</li>
          <li>You can also use Nerdamer directly:
            <ul>
              <li><code>integrate(sin(x)^2, x)</code></li>
              <li><code>defint(x^2+y^2, x, 0, 1)</code></li>
            </ul>
          </li>
        </ul>
        <b>Notes:</b>
        <ul>
          <li>For double/triple integrals, the order of <code>d...</code> at the end matches the iterated integrals.</li>
          <li>If a line isn’t recognized as an integral, you’ll get an error instead of a guess.</li>
        </ul>
      </div>

      <!-- Report Problem / Contact -->
      <div style="margin-top:14px;border-top:1px solid #242635;padding-top:10px;">
        <button id="reportBtn">Report a Problem / Contact Us</button>
        <div id="reportPanel" style="display:none;margin-top:6px;">
          <textarea id="reportMsg"
            style="width:100%;min-height:90px;background:#0f1017;color:var(--ink);border:1px solid #242635;border-radius:10px;padding:8px;resize:vertical"
            placeholder="What did you type? What happened? What did you expect?"></textarea>
          <div class="row" style="margin-top:6px">
            <button id="reportSubmit">Submit</button>
            <button id="reportCancel">Cancel</button>
          </div>
          <div id="reportStatus" class="muted"></div>
        </div>
      </div>
    </section>

    <p style="text-align:center; margin:16px 0 32px;">
      <a href="privacy.html">Privacy Policy</a> |
      <a href="terms.html">Terms &amp; Conditions</a>
    </p>
  </div>

<script>
/* ===== Helpers ===== */
const editor     = document.getElementById('editor');
const statusEl   = document.getElementById('status');
const stepsPanel = document.getElementById('stepsPanel');
const stepsContent = document.getElementById('stepsContent');

let lastAnswer = '';
let lastStepsHTML = '';

function flashStatus(msg){
  statusEl.textContent = msg;
  if (!msg) return;
  setTimeout(()=>{ statusEl.textContent=''; }, 2000);
}

function escHtml(s){
  return String(s).replace(/[&<>]/g, ch => (
    ch === '&' ? '&amp;' :
    ch === '<' ? '&lt;'  :
    '&gt;'
  ));
}

/* Cheap ASCII → TeX-ish for display in MathJax */
function exprToTex(s){
  let t = String(s);
  t = t.replace(/pi\b/g, '\\pi');
  t = t.replace(/sin\(/g, '\\sin(');
  t = t.replace(/cos\(/g, '\\cos(');
  t = t.replace(/tan\(/g, '\\tan(');
  t = t.replace(/log\(/g, '\\log(');
  t = t.replace(/ln\(/g, '\\ln(');
  return t;
}

function updateSteps(html){
  lastStepsHTML = html || '<p class="muted">No steps available for this input.</p>';
  stepsContent.innerHTML = lastStepsHTML;
  // Keep it hidden until user clicks "Show steps"
  // but if it is already open, re-typeset.
  if (stepsPanel.style.display === 'block') {
    if (window.MathJax && window.MathJax.typesetPromise) {
      MathJax.typesetPromise([stepsContent]).catch(()=>{});
    }
  }
}

/* ===== Auto-transform: 'int ' → '∫ ' ===== */
editor.addEventListener('input', function(){
  const value = editor.value;
  const pos   = editor.selectionStart;

  if (pos >= 4 && value.slice(pos-4, pos) === 'int ') {
    const before = value.slice(0, pos-4);
    const after  = value.slice(pos);
    const newVal = before + '∫ ' + after;
    const newPos = before.length + 2;  // '∫ ' is 2 chars

    editor.value = newVal;
    editor.selectionStart = editor.selectionEnd = newPos;
  }
});

/* ===== Integral solving logic (single, double, triple, direct Nerdamer) ===== */

function solveIntegralFromLine(rawLine){
  const line = rawLine.trim();
  const result = { answer: '', stepsHTML: '' };

  if (!line) return result;

  try {
    /* 1. Direct Nerdamer calls (advanced usage) */
    if (/(^|[^a-zA-Z])integrate\s*\(/.test(line) ||
        /(^|[^a-zA-Z])defint\s*\(/.test(line)) {
      const res = nerdamer(line).simplify();
      result.answer = res.toString();
      const texRes = exprToTex(result.answer);
      result.stepsHTML = `
        <p><b>Input (Nerdamer):</b></p>
        <p><code>${escHtml(line)}</code></p>
        <p><b>Result (simplified):</b></p>
        <p>$$${texRes}$$</p>`;
      return result;
    }

    /* 2. Definite integral with bracket syntax: ∫[a,b] f(x) dx */
    const mBracket = line.match(/^∫\s*\[\s*([^,]+)\s*,\s*([^\]]+)\s*\]\s*(.+)\s+d([a-zA-Z])$/);
    if (mBracket) {
      const a = mBracket[1].trim();
      const b = mBracket[2].trim();
      const f = mBracket[3].trim();
      const v = mBracket[4].trim();

      const F = nerdamer.integrate(f, v).simplify();   // antiderivative
      const val = nerdamer.defint(f, v, a, b).simplify();

      const texIntegral = `\\int_{${exprToTex(a)}}^{${exprToTex(b)}} ${exprToTex(f)}\\, d${v}`;
      const texF = exprToTex(F.toString());
      const texVal = exprToTex(val.toString());

      result.answer = val.toString();
      result.stepsHTML = `
        <p><b>Given definite integral:</b></p>
        <p>$$${texIntegral}$$</p>
        <p><b>1. Find an antiderivative:</b></p>
        <p>$$F(${v}) = ${texF}$$</p>
        <p><b>2. Evaluate at the bounds:</b></p>
        <p>$$\\int_{${exprToTex(a)}}^{${exprToTex(b)}} ${exprToTex(f)}\\, d${v}
            = F(${exprToTex(b)}) - F(${exprToTex(a)})$$</p>
        <p><b>3. Final result:</b></p>
        <p>$$${texVal}$$</p>
      `;
      return result;
    }

    /* 3. Iterated integrals (single / double / triple / etc.) using ∫ ... dx dy dz */
    let s = line;
    let i = 0;
    let count = 0;
    while (i < s.length) {
      const ch = s[i];
      if (ch === '∫') {
        count++;
        i++;
      } else if (ch === ' ' || ch === '\t') {
        i++;
      } else {
        break;
      }
    }

    if (count > 0) {
      let expr = s.slice(i).trim(); // stuff after the ∫ symbols
      let vars = [];

      // Peel off trailing "d<var>" blocks from right to left
      while (true) {
        const m = expr.match(/^(.*)\bd([a-zA-Z])\s*$/);
        if (!m) break;
        vars.push(m[2]);          // variable name (e.g. x, y, z)
        expr = m[1].trim();       // remaining expression
      }

      if (vars.length === 0) {
        throw new Error('Could not find variable(s) like dx, dy, dz at the end.');
      }
      if (vars.length !== count) {
        throw new Error(`Found ${count} integral sign(s) but ${vars.length} variable(s).`);
      }

      // Integrate from inner to outer
      let resExpr = expr;
      const intermediate = [];
      const integrOrder = [];

      for (let k = vars.length - 1; k >= 0; k--) {
        const v = vars[k];
        resExpr = nerdamer.integrate(resExpr, v).toString();
        intermediate.push({ v, expr: resExpr });
        integrOrder.push(v);
      }

      const finalExpr = nerdamer(resExpr).simplify();
      result.answer = finalExpr.toString();

      const typedOrder = vars.slice().reverse();  // order as in "dx dy ..."
      const texOriginal = `${'\\int '.repeat(count)} ${exprToTex(expr)}\\, ${typedOrder.map(v => 'd'+v).join('\\, ')}`;
      const texSteps = intermediate.map((step, idx) => {
        const v = step.v;
        const texF = exprToTex(step.expr);
        return `<p><b>${idx+1}. Integrate w.r.t. ${v}:</b></p>
                <p>$$${texF}$$</p>`;
      }).join('');

      const texFinal = exprToTex(finalExpr.toString());

      result.stepsHTML = `
        <p><b>Iterated integral:</b></p>
        <p>$$${texOriginal}$$</p>
        ${texSteps}
        <p><b>Final result:</b></p>
        <p>$$${texFinal}$$</p>
      `;
      return result;
    }

    /* 4. Not recognized as an integral */
    throw new Error('Line not recognized as an integral. Start with "int " (→ ∫) or use integrate(...)/defint(...).');

  } catch (err) {
    const msg = 'Error: ' + (err && err.message ? err.message : String(err));
    result.answer = msg;
    result.stepsHTML = `<p>${escHtml(msg)}</p>`;
    return result;
  }
}

/* ===== Enter behavior: solve + insert answer two lines below ===== */
editor.addEventListener('keydown', function(e){
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();

    const value = editor.value;
    const pos = editor.selectionStart;

    // locate current line
    const lineStart = value.lastIndexOf('\n', pos-1) + 1;
    let lineEnd = value.indexOf('\n', pos);
    if (lineEnd === -1) lineEnd = value.length;

    const line = value.slice(lineStart, lineEnd);

    // If line is empty, just insert a normal newline
    if (!line.trim()) {
      const before = value.slice(0, pos);
      const after  = value.slice(pos);
      editor.value = before + '\n' + after;
      const newPos = pos + 1;
      editor.selectionStart = editor.selectionEnd = newPos;
      return;
    }

    const { answer, stepsHTML } = solveIntegralFromLine(line);
    lastAnswer = answer;
    updateSteps(stepsHTML);

    // Insert answer two lines below the current line:
    // [lineEnd]\n\n= answer
    const beforeLineEnd = value.slice(0, lineEnd);
    const afterLineEnd  = value.slice(lineEnd);
    const insertion = '\n\n= ' + answer;

    editor.value = beforeLineEnd + insertion + afterLineEnd;

    // place caret at end of inserted answer line
    const newCaretPos = (beforeLineEnd + insertion).length;
    editor.selectionStart = editor.selectionEnd = newCaretPos;

    flashStatus('Solved integral.');
  }
});

/* Clear + copy last answer */
document.getElementById('clearBtn').addEventListener('click', ()=>{
  editor.value = '';
  lastAnswer = '';
  updateSteps('');
  flashStatus('Cleared.');
  editor.focus();
});

document.getElementById('copyLastBtn').addEventListener('click', async ()=>{
  if (!lastAnswer) {
    flashStatus('No answer yet to copy.');
    return;
  }
  try {
    await navigator.clipboard.writeText(lastAnswer);
    flashStatus('Last answer copied.');
  } catch {
    flashStatus('Could not copy (clipboard blocked).');
  }
});

/* Show steps dropdown toggle */
document.getElementById('showStepsBtn').addEventListener('click', ()=>{
  if (stepsPanel.style.display === 'block') {
    stepsPanel.style.display = 'none';
  } else {
    stepsPanel.style.display = 'block';
    stepsContent.innerHTML = lastStepsHTML || '<p class="muted">No steps yet. Solve an integral first.</p>';
    if (window.MathJax && window.MathJax.typesetPromise) {
      MathJax.typesetPromise([stepsContent]).catch(()=>{});
    }
  }
});

/* ===== Report Problem (mailto) ===== */
const reportBtn     = document.getElementById('reportBtn');
const reportPanel   = document.getElementById('reportPanel');
const reportMsg     = document.getElementById('reportMsg');
const reportSubmit  = document.getElementById('reportSubmit');
const reportCancel  = document.getElementById('reportCancel');
const reportStatus  = document.getElementById('reportStatus');

reportBtn.addEventListener('click', ()=>{
  const show = reportPanel.style.display !== 'block';
  reportPanel.style.display = show ? 'block' : 'none';
  if (show) reportMsg.focus();
});

reportCancel.addEventListener('click', ()=>{
  reportPanel.style.display='none';
  reportStatus.textContent='';
});

reportSubmit.addEventListener('click', ()=>{
  const msg = (reportMsg.value || '').trim();
  if (!msg){
    reportStatus.textContent='Please write a short description.';
    return;
  }
  const subject = encodeURIComponent('Integral Calculator — Problem Report');
  const context = '\n\n---\nCurrent editor contents (truncated):\n' +
                  (editor.value || '').slice(0, 4000);
  const body    = encodeURIComponent(msg + context);
  const mailto  = `mailto:oliver.c1639@gmail.com?subject=${subject}&body=${body}`;

  reportPanel.style.display = 'none';
  reportStatus.textContent  = 'Thanks! Your mail app should open — just hit send.';
  window.location.href = mailto;
});
</script>
</body>
</html>
